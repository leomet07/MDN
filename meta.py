import numpy as np


def find_wavelength(k, waves, validate=True, tol=5):
    ''' Index of closest wavelength '''
    waves = np.array(waves)
    w = np.atleast_1d(k)
    i = np.abs(waves - w[:, None]).argmin(1)
    assert (not validate or (np.abs(w - waves[
        i]).max() <= tol)), f'Needed {k}, but closest was {waves[i]} in {waves} ({np.abs(w - waves[i]).max()} > {tol})'
    return i.reshape(np.array(k).shape)


def closest_wavelength(k, waves, validate=True, tol=5):
    ''' Value of closest wavelength '''
    waves = np.array(waves)
    return waves[find_wavelength(k, waves, validate, tol)]


SENSOR_LABEL = {  # http://www.ioccg.org/sensors/seawifs.html
    'CZCS': 'Nimbus-7',
    'TM': 'Landsat-5',
    'ETM': 'Landsat-7',
    'OLI': 'Landsat-8',
    'OSMI': 'Arirang-1',
    'POLDER': 'POLDER',
    'AER': 'AERONET',
    'OCTS': 'ADEOS-1',
    'SEAWIFS': 'OrbView-2',
    'VI': 'Suomi-NPP',
    'MOS': 'MOS-1',
    'MOD': 'MODIS',
    'MODA': 'MODIS-Aqua',
    'MODT': 'MODIS-Terra',
    'MSI': 'Sentinel-2',
    'S2A': 'Sentinel-2A',
    'S2B': 'Sentinel-2B',
    'S3A': 'Sentinel-3A',
    'S3B': 'Sentinel-3B',
    'OLCI': 'Sentinel-3',
    'MERIS': 'Envisat-1',
    'HICO': 'HICO',
    'PRISMA': 'PRISMA',
    'PACE': 'PACE',
    'EMIT': 'EMIT',
    'PRISM': 'PRISM',
    'AVIRISNG': 'AVIRISNG',
    'HYPER': '1nm Hyperspectral',
}


def get_sensor_label(sensor):
    sensor, *ext = sensor.split('-')
    assert (sensor in SENSOR_LABEL), f'Unknown sensor: {sensor}'

    label = SENSOR_LABEL[sensor]
    if 'pan' in ext:
        label += '+Pan'
    return label


# --------------------------------------------------------------

SENSOR_BANDS = {
    'CZCS': [443, 520, 550, 670],
    'TM': [490, 560, 660],
    'ETM': [483, 560, 662],
    'ETM-pan': [483, 560, 662, 706],
    'OLI': [443, 482, 561, 655],
    'OLI-SOLID': [443, 482, 561, 655],
    'OLI-pan': [443, 482, 561, 589, 655, ],
    'OLI-full': [443, 482, 561, 655, 865],
    'OLI-nan': [443, 482, 561, 589, 655, 865],
    'OLI-rho': [443, 482, 561, 655, 865, 1609],
    'OSMI': [412, 443, 490, 555, 765],
    'POLDER': [443, 490, 565, 670, 765],
    'AER': [412, 442, 490, 560, 668],
    'OCTS': [412, 443, 490, 520, 565, 670, 765],
    'SEAWIFS': [412, 443, 490, 510, 555, 670, 765],
    'VI': [410, 443, 486, 551, 671, 745],
    'VI-sat': [443, 486, 551, 671, 745],
    'VI-sat_no_NIR': [443, 486, 551, 671, ],
    'VI-SOLID': [410, 443, 486, 551, 671, ],
    'MOS': [408, 443, 485, 520, 570, 615, 650, 685, 750],
    'MOD': [412, 443, 469, 488, 531, 551, 555, 645, 667, 678, 748],
    'MOD-IOP': [412, 443, 469, 488, 531, 551, 555, 645, 667, 678, ],
    'MOD-sat': [412, 443, 469, 488, 531, 551, 555, 645, 667, 678, ],
    'MOD-sat': [443, 469, 488, 531, 551, 555, 645, 748],
    'MODA-sat_no_NIR': [443, 469, 488, 531, 551, 555, 645, ],
    'MOD-poly': [412, 443, 488, 531, 551, 667, 678, 748],
    'MOD-SOLID': [412, 443, 488, 551, 667, 678, ],
    'MSI': [443, 490, 560, 665, 705, 740, 783],
    'MSI-SOLID': [443, 490, 560, 665, 705, ],
    'MSI-rho': [443, 490, 560, 665, 705, 740, 783, 865],
    'OLCI': [411, 442, 490, 510, 560, 619, 664, 673, 681, 708, 753, 778],
    'OLCI-rho': [411, 442, 490, 510, 560, 619, 664, 673, 681, 708, 753, 768, 778, 865, 884, 1016],
    'OLCI-full': [411, 442, 490, 510, 560, 619, 664, 673, 681, 708, 753, 761, 764, 767, 778],
    'OLCI-poly': [411, 442, 490, 510, 560, 619, 664, 681, 708, 753, 778],
    'OLCI-sam': [411, 442, 490, 510, 560, 619, 664, 673, 681, 708, 753, ],
    'OLCI-SOLID': [411, 442, 490, 510, 560, 619, 664, 673, 681, ],
    'OLCI-sat': [442, 490, 510, 560, 619, 664, 673, 681, 708, ],
    'MERIS': [412, 442, 490, 510, 560, 620, 665, 681, 708, 753, 760, 778],

    'HICO-full': [409, 415, 421, 426, 432, 438, 444, 449, 455, 461, 467, 472, 478, 484, 490, 495, 501, 507,
                  512, 518, 524, 530, 535, 541, 547, 553, 558, 564, 570, 575, 581, 587, 593, 598, 604, 610,
                  616, 621, 627, 633, 638, 644, 650, 656, 661, 667, 673, 679, 684, 690, 696, 701, 707, 713,
                  719, 724, 730, 736, 742, 747, 753, 759, 764, 770, 776, 782, 787],
    'HICO-chl': [501, 507, 512, 518, 524, 530, 535, 541, 547, 553, 558, 564, 570, 575, 581, 587, 593, 598,
                 604, 610, 616, 621, 627, 633, 638, 644, 650, 656, 661, 667, 673, 679, 684, 690, 696, 701,
                 707, 713],
    'HICO-IOP': [409, 415, 421, 426, 432, 438, 444, 449, 455, 461, 467, 472, 478, 484, 490, 495, 501, 507,
                 512, 518, 524, 530, 535, 541, 547, 553, 558, 564, 570, 575, 581, 587, 593, 598, 604, 610,
                 616, 621, 627, 633, 638, 644, 650, 656, 661, 667, 673, 679, 684, 690],
    # absorption data becomes negative > 690nm
    'HICO': [409, 415, 421, 426, 432, 438, 444, 449, 455, 461, 467, 472, 478, 484, 490, 495, 501, 507,
             512, 518, 524, 530, 535, 541, 547, 553, 558, 564, 570, 575, 581, 587, 593, 598, 604, 610,
             616, 621, 627, 633, 638, 644, 650, 656, 661, 667, 673, 679, 684, 690, 696, 701, 707, 713, 719, 724],

    'HICO-aph': [409, 415, 421, 426, 432, 438, 444, 449, 455, 461, 467, 472, 478, 484, 490, 495, 501, 507,
                 512, 518, 524, 530, 535, 541, 547, 553, 558, 564, 570, 575, 581, 587, 593, 598, 604, 610,
                 616, 621, 627, 633, 638, 644, 650, 656, 661, 667, 673, 679, 684, 690],

    'PRISMA': [411, 419, 427, 434, 441, 449, 456, 464, 471, 478, 485, 493, 500, 507, 515, 523, 530,
               538, 546, 554, 563, 571, 579, 588, 596, 605, 614, 623, 632, 641, 651, 660, 670, 679, 689,
               699, 709, 719, ],

    'PRISMA-aph': [411, 419, 427, 434, 441, 449, 456, 464, 471, 478, 485, 493, 500, 507, 515, 523, 530,
                   538, 546, 554, 563, 571, 579, 588, 596, 605, 614, 623, 632, 641, 651, 660, 670, 679, 689, ],

    'PRISMA-adag': [412, 440, 488, 532, 560, 630, 650, 676, ],

    'HICO-adag': [412, 440, 488, 532, 560, 630, 650, 676, ],

    'EMIT': [410.6, 418.1, 425.5, 432.9, 440.3, 447.7, 455.2, 462.6, 470.0,
             477.5, 484.9, 492.3, 499.8, 507.2, 514.7, 522.1, 529.5, 537.0, 544.4, 551.9, 559.3, 566.8,
             574.2, 581.7, 589.1, 596.6, 604.0, 611.5, 618.9, 626.4, 633.8, 641.3, 648.7, 656.2, 663.6,
             671.1, 678.6, 686.0, 693.5, 700.9, 708.4, 715.8, ],

    'PRISM': [410.0020299, 412.8334677, 415.6649616,  # 401.5080542,  404.3393232, 407.1706485,
			  418.4965118, 421.3281183, 424.1597809, 426.9914999, 429.823275, 432.6551064, 435.4869941, 438.3189379,
			  441.1509381, 443.9829944, 446.815107, 449.6472759, 452.4795009, 455.3117823, 458.1441198, 460.9765136,
			  463.8089637, 466.6414699, 469.4740325, 472.3066512, 475.1393262, 477.9720575, 480.8048449, 483.6376887,
			  486.4705886, 489.3035448, 492.1365573, 494.9696259, 497.8027509, 500.635932, 503.4691694, 506.3024631,
			  509.1358129, 511.9692191, 514.8026814, 517.6362, 520.4697749, 523.3034059, 526.1370933, 528.9708368,
			  531.8046366, 534.6384927, 537.4724049, 540.3063735, 543.1403982, 545.9744792, 548.8086165, 551.6428099,
			  554.4770597, 557.3113656, 560.1457278, 562.9801463, 565.8146209, 568.6491519, 571.483739, 574.3183824,
			  577.1530821, 579.9878379, 582.8226501, 585.6575184, 588.492443, 591.3274239, 594.1624609, 596.9975543,
			  599.8327038, 602.6679096, 605.5031717, 608.3384899, 611.1738645, 614.0092952, 616.8447822, 619.6803255,
			  622.5159249, 625.3515807, 628.1872926, 631.0230608, 633.8588853, 636.6947659, 639.5307029, 642.366696,
			  645.2027454, 648.0388511, 650.8750129, 653.7112311, 656.5475054, 659.383836, 662.2202229, 665.0566659,
			  667.8931653, 670.7297208, 673.5663326, 676.4030007, 679.2397249, 682.0765055, 684.9133422, 687.7502352,
			  690.5871845, 693.4241899, 696.2612517, 699.0983696, 701.9355438, 704.7727743, 707.6100609, 710.4474039,
			  713.284803, 716.1222584, 718.9597701, 721.7973379, ],
    # 724.6349621,  727.4726424,  730.310379 ,  733.1481719,
    # 735.9860209,  738.8239263,  741.6618878,  744.4999056, 747.3379797,  750.1761099,  753.0142965,  755.8525392,
    # 758.6908382,  761.5291935,  764.3676049,  767.2060727, 770.0445966,  772.8831768,  775.7218133,  778.5605059,
    # 781.3992549,  784.23806  ,  787.0769214,  789.9158391, 792.7548129,  795.5938431,  798.4329294,  801.272072

    'AVIRISNG': [412.25565, 417.26566, 422.27563,
				 # 377.19565,  382.20566,  387.21564,  392.22565,  397.22565, 402.23566,  407.24564,
				 427.28564, 432.29565, 437.29565, 442.30566, 447.31564,
				 452.32565, 457.33566, 462.34564, 467.35565, 472.35565,
				 477.36566, 482.37564, 487.38565, 492.39566, 497.40564,
				 502.41565, 507.42566, 512.42566, 517.43567, 522.4457,
				 527.4556, 532.46564, 537.47565, 542.48566, 547.48566,
				 552.49567, 557.5057, 562.5156, 567.52563, 572.53564,
				 577.54565, 582.55566, 587.55566, 592.5657, 597.5756,
				 602.58563, 607.59564, 612.60565, 617.61566, 622.61566,
				 627.6257, 632.6356, 637.6456, 642.65564, 647.66565,
				 652.67566, 657.68567, 662.68567, 667.6957, 672.7056,
				 677.71564, 682.72565, 687.73566, 692.74567, 697.74567,
				 702.7557, 707.7656, 712.77563, 717.78564, 722.79565, ],
    # 727.80566,  732.8157 ,  737.8157 ,  742.8256 ,  747.83563,
    # 752.84564,  757.85565,  762.86566,  767.8757 ,  772.8757 ,
    # 777.8856 ,  782.8956 ,  787.90564,  792.91565,  797.92566,
    # 802.93567, ].

    'PACE': [410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490, 495,
             500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565, 570, 575, 580, 585,
             590, 595, 600, 605, 610, 615, 620, 625, 630, 635, 640, 645, 650, 655, 660, 665, 670, 675,
             680, 685, 690, 695, 700, 705, 710, 715, 720, ],

    'PACE-rho': [410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490, 495,
                 500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565, 570, 575, 580, 585,
                 590, 595, 600, 605, 610, 615, 620, 625, 630, 635, 640, 645, 650, 655, 660, 665, 670, 675,
                 680, 685, 690, 695, 700, 705, 710, 715, 720, ],

    'PACE-sat': [410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490, 495,
                 500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565, 570, 575, 580, 585,
                 590, 595, 600, 605, 610, 615, 625, 630, 635, 640, 645, 650, 655, 660, 665, 670, 675,
                 680, 700, 705, 710, 715, ],

    'PACE-sat-rho': [410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490, 495,
                     500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565, 570, 575, 580, 585,
                     590, 595, 600, 605, 610, 615, 625, 630, 635, 640, 645, 650, 655, 660, 665, 670, 675,
                     680, 700, 705, 710, 715, ],

    'PACE-delivery': [410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490, 495,
                      500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565, 570, 575, 580, 585,
                      590, 615, 620, 625, 630, 635, 640, 645, 650, 655, 660, 665, 670, 675,
                      680, 685, 690, 695, 700, 705, 710, 715, 720],

    'PACE-aph': [410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490, 495,
                 500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565, 570, 575, 580, 585,
                 590, 595, 600, 605, 610, 615, 620, 625, 630, 635, 640, 645, 650, 655, 660, 665, 670, 675,
                 680, 685, 690, ],

    'PACE-adag': [410, 440, 490, 530, 560, 630, 650, 675, ],

    'HYPER': list(range(400, 799)),
    'HYPER-nan': list(range(400, 801)),
}
for sensor in ['EMIT', 'PRISM', 'AVIRISNG']:
    SENSOR_BANDS[sensor] = np.rint(SENSOR_BANDS[sensor])

for sensor in ['EMIT', 'PRISM', 'AVIRISNG', 'PACE-sat', 'PACE-delivery']:
    SENSOR_BANDS[sensor + '-aph'] = np.unique(
        closest_wavelength(SENSOR_BANDS['PACE-aph'], SENSOR_BANDS[sensor], validate=False))
    SENSOR_BANDS[sensor + '-adag'] = np.unique(
        closest_wavelength(SENSOR_BANDS['PACE-adag'], SENSOR_BANDS[sensor], validate=False))
    SENSOR_BANDS[sensor + '-rho'] = np.unique(
        closest_wavelength(SENSOR_BANDS['PACE-rho'], SENSOR_BANDS[sensor], validate=False))

duplicates = {
    'MOD': ['MODA', 'MODT'],
    'MSI': ['S2A', 'S2B'],
    'OLCI': ['S3A', 'S3B'],

}

# Add duplicate sensors
for sensor in list(SENSOR_BANDS.keys()):
    for sensor2, dups in duplicates.items():
        if sensor2 in sensor:
            for dup in dups:
                SENSOR_BANDS[sensor.replace(sensor2, dup)] = SENSOR_BANDS[sensor]


def get_sensor_bands(sensor, args=None):
    assert (sensor in SENSOR_BANDS), f'Unknown sensor: {sensor}'
    bands = set()
    if args is not None:

        # Specific bands can be passed via args in order to override those used
        if hasattr(args, 'bands'):
            return np.array(args.bands.split(',') if isinstance(bands, str) else args.bands)

        # The provided bands can change if satellite bands with certain products are requested
        elif args.sat_bands:
            product_keys = {
                'chl': ['chl'],
                'IOP': ['aph', 'a*ph', 'ag', 'ad'],
            }

            for key, products in product_keys.items():
                for product in args.product.split(','):
                    if (f'{sensor}-{key}' in SENSOR_BANDS) and (product in products):
                        bands |= set(SENSOR_BANDS[f'{sensor}-{key}'])

            if len(bands) == 0 and f'{sensor}-sat' in SENSOR_BANDS:
                sensor = f'{sensor}-sat'

    if len(bands) == 0:
        bands = SENSOR_BANDS[sensor]
    return np.sort(list(bands))


# --------------------------------------------------------------

# Ancillary parameters for certain models
ANCILLARY = [
    'humidity',  # Relative humidity (%)
    'ice_frac',  # Ice fraction (0=no ice, 1=all ice)
    'no2_frac',  # Fraction of tropospheric NO2 above 200m
    'no2_strat',  # Stratospheric NO2 (molecules/cm^2)
    'no2_tropo',  # Tropospheric NO2 (molecules/cm^2)
    'ozone',  # Ozone concentration (cm)
    'pressure',  # Surface pressure (millibars)
    'mwind',  # Meridional wind speed @ 10m (m/s)
    'zwind',  # Zonal wind speed @ 10m (m/s)
    'windangle',  # Wind direction @ 10m (degree)
    'windspeed',  # Wind speed @ 10m (m/s)
    'scattang',  # Scattering angle (degree)
    'senz',  # Sensor zenith angle (degree)
    'sola',  # Solar azimuth angle (degree)
    'solz',  # Solar zenith angle (degree)
    'water_vapor',  # Precipitable water vapor (g/cm^2)
    'time_diff',  # Difference between in situ measurement and satellite overpass (in situ prior to overpass = negative)
]

# Ancillary parameters which are periodic (e.g. 0 degrees == 360 degrees)
PERIODIC = [
    'windangle',
]
